<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aprovação de CAPs</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
    h1 { text-align: center; }
    select, button { padding: 8px; margin: 10px 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background: #007bff; color: white; }
    tr:nth-child(even) { background: #f9f9f9; }
    .status-btn { padding: 6px 10px; margin: 2px; cursor: pointer; border: none; border-radius: 4px; }
    .aprovado { background: #28a745; color: white; }
    .reprovado { background: #dc3545; color: white; }
    .pendente { background: #ffc107; color: black; }
  </style>
</head>
<body>
  <h1>✅ Aprovação de CAPs</h1>
  <label for="filtroEmpresa">Filtrar por Empresa:</label>
  <select id="filtroEmpresa" onchange="filtrarEmpresa()">
    <option value="">Todas</option>
  </select>
  <button onclick="aprovarSelecionados()">✅ Aprovar Selecionados</button>

  <table id="tabelaCAPs">
    <thead>
      <tr>
        <th><input type="checkbox" id="marcarTodos" onclick="toggleTodos()"></th>
        <th>Empresa</th>
        <th>Cliente</th>
        <th>Vencimento</th>
        <th>Valor</th>
        <th>Status</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let todosCAPs = [];

    async function carregarCAPs() {
      const res = await fetch('https://script.google.com/macros/s/SEU_SCRIPT_ID/exec');
      todosCAPs = await res.json();
      preencherTabela(todosCAPs);
      preencherFiltroEmpresas(todosCAPs);
    }

    function preencherTabela(dados) {
      const tbody = document.querySelector('#tabelaCAPs tbody');
      tbody.innerHTML = '';
      dados.forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="chk" data-linha="${item._linha}"></td>
          <td>${item["Empresa"] || ''}</td>
          <td>${item["Cliente / Fornecedor"] || ''}</td>
          <td>${item["Vencimento"] || ''}</td>
          <td>R$ ${parseFloat(item["Valor Bruto"] || 0).toFixed(2)}</td>
          <td>${item["Status"] || 'PENDENTE'}</td>
          <td>
            <button class="status-btn aprovado" onclick="atualizarStatus(${item._linha}, 'APROVADO')">Aprovar</button>
            <button class="status-btn reprovado" onclick="atualizarStatus(${item._linha}, 'REPROVADO')">Reprovar</button>
            <button class="status-btn pendente" onclick="atualizarStatus(${item._linha}, 'PENDENTE')">Pendente</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function preencherFiltroEmpresas(dados) {
      const select = document.getElementById('filtroEmpresa');
      const empresas = [...new Set(dados.map(d => d["Empresa"]))];
      empresas.forEach(emp => {
        const opt = document.createElement('option');
        opt.value = emp;
        opt.textContent = emp;
        select.appendChild(opt);
      });
    }

    function filtrarEmpresa() {
      const empresa = document.getElementById('filtroEmpresa').value;
      const filtrados = empresa ? todosCAPs.filter(c => c["Empresa"] === empresa) : todosCAPs;
      preencherTabela(filtrados);
    }

    function toggleTodos() {
      const marcar = document.getElementById('marcarTodos').checked;
      document.querySelectorAll('.chk').forEach(chk => chk.checked = marcar);
    }

    async function atualizarStatus(linha, status) {
      const res = await fetch('https://script.google.com/macros/s/SEU_SCRIPT_ID/exec', {
        method: 'POST',
        body: JSON.stringify({ linha, novoStatus: status }),
        headers: { 'Content-Type': 'application/json' }
      });
      const r = await res.json();
      if (r.status === 'sucesso') carregarCAPs();
    }

    function aprovarSelecionados() {
      const selecionados = document.querySelectorAll('.chk:checked');
      if (!selecionados.length) return alert("Selecione pelo menos um título para aprovar.");
      selecionados.forEach(async chk => {
        const linha = chk.getAttribute('data-linha');
        await atualizarStatus(linha, 'APROVADO');
      });
    }

    carregarCAPs();
  </script>
</body>
</html>
